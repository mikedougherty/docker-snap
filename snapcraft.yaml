name: docker
version: 1.12.3-0
summary: Docker Linux container runtime
description: Docker complements kernel namespacing with a high-level API which operates at the process level. It runs unix processes with strong guarantees of isolation and repeatability across servers.

confinement: strict
grade: stable

plugs:
  support:
    interface: docker-support
  privileged:
    interface: docker-support
    privileged-containers: true
  docker-cli:
    interface: docker
slots:
  docker-daemon:
    interface: docker

apps:
  docker:
    command: docker-wrapper docker
    plugs:
      - docker-cli
      - network
      - home

  dockerd:
    command: dockerd-wrapper
    daemon: simple
    plugs:
      - network-bind
      - firewall-control
      - support
      - privileged
    slots:
      - docker-daemon

  # TODO determine if we can "provide" a "docker-compose" in PATH directly (since this'll show up as "docker.compose" in the user PATH)
  compose:
    command: docker-wrapper docker-compose
    plugs:
      - docker-cli
      - network
      - home

parts:
  snappy-bins:
    plugin: shell
    shell: bash
    shell-flags: ['-ex']
    shell-command: |
      install -d "$DESTDIR/bin"
      install -t "$DESTDIR/bin" "$SNAPDIR"/bin/*
    stage-packages:
      #- adduser
      - mount

  docker:
    plugin: shell
    source: https://github.com/docker/docker/archive/v1.12.3.tar.gz
    source-type: tar
    shell: bash
    shell-flags: ['-eux', '-o', 'pipefail']
    shell-command: |
      source "$SNAPDIR/prep-docker-build.sh"

      ./hack/make.sh dynbinary

      ls -l bundles/latest/*/

      dockerClientBin='bundles/latest/dynbinary-client/docker'
      dockerDaemonBin='bundles/latest/dynbinary-daemon/dockerd'
      dockerProxyBin='bundles/latest/dynbinary-daemon/docker-proxy'

      # No way to check docker-proxy version apparently...

      "$dockerClientBin" -v
      "$dockerClientBin" -v | grep -q -- "$DOCKER_GITCOMMIT"

      "$dockerDaemonBin" -v
      "$dockerDaemonBin" -v | grep -q -- "$DOCKER_GITCOMMIT"

      install -d "$DESTDIR/bin"
      install -T "$(readlink -f "$dockerClientBin")" "$DESTDIR/bin/docker"
      install -T "$(readlink -f "$dockerDaemonBin")" "$DESTDIR/bin/dockerd"
      install -T "$(readlink -f "$dockerProxyBin")" "$DESTDIR/bin/docker-proxy"
    build-packages:
      - pkg-config
      - btrfs-tools
      - gcc
      - golang-go
      - libc6-dev
      - libdevmapper-dev
      - libltdl-dev
      - patch
    stage-packages:
      - aufs-tools

  containerd:
    plugin: shell
    #source: https://github.com/docker/containerd/archive/v0.2.2.tar.gz
    #source: https://github.com/docker/containerd/archive/9dc2b3273db42c75368988a3885a3afd770069d9.tar.gz
    # https://github.com/docker/docker/blob/v1.11.2/Dockerfile#L254
    source: https://github.com/docker-snap/containerd/archive/arm64-epoll-backport.tar.gz
    source-type: tar
    shell: bash
    shell-flags: ['-ex']
    shell-command: |
      mkdir -p .gopath/src/github.com/docker
      ln -sfT "$PWD" .gopath/src/github.com/docker/containerd
      export GOPATH="$PWD/.gopath"

      make GIT_COMMIT= GIT_BRANCH= LDFLAGS=

      install -d "$DESTDIR/bin"
      install -T bin/containerd "$DESTDIR/bin/docker-containerd"
      install -T bin/containerd-shim "$DESTDIR/bin/docker-containerd-shim"
      install -T bin/ctr "$DESTDIR/bin/docker-containerd-ctr"
    build-packages:
      - golang-go
      - make

  runc:
    plugin: shell
    source: https://github.com/opencontainers/runc/archive/v0.1.1.tar.gz
    source-type: tar
    shell: bash
    shell-flags: ['-ex']
    shell-command: |
      mkdir -p .gopath/src/github.com/opencontainers
      ln -sfT "$PWD" .gopath/src/github.com/opencontainers/runc
      export GOPATH="$PWD/.gopath"

      make BUILDTAGS='seccomp apparmor selinux' COMMIT=

      install -d "$DESTDIR/bin"
      install -T runc "$DESTDIR/bin/docker-runc"
    build-packages:
      - golang-go
      - libapparmor-dev
      - libseccomp-dev
      - make

  compose:
    plugin: python2
    source: https://github.com/docker/compose/archive/1.8.1.tar.gz
    source-type: tar

# vim:set et ts=2 sw=2:
